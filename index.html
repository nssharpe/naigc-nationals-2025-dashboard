<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAIGC Nationals 2025 â€” Competition Results Dashboard</title>
    <style>
        body { margin: 0; padding: 1rem; background: #f5f6fa; }
    </style>
</head>
<body>

<style>
    .nrd-dashboard { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; color: #333; line-height: 1.5; }
    .nrd-dashboard * { box-sizing: border-box; }
    .nrd-dashboard .nrd-header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color: white; padding: 2rem 2rem 1.5rem; text-align: center; border-radius: 10px 10px 0 0; margin-bottom: 0; }
    .nrd-dashboard .nrd-header h1 { font-size: 1.8rem; font-weight: 700; margin: 0 0 0.3rem 0; padding: 0; color: white; }
    .nrd-dashboard .nrd-header .subtitle { font-size: 1rem; opacity: 0.8; }
    .nrd-dashboard .nrd-main { max-width: 1200px; margin: 0 auto; padding: 1.5rem 0; }
    .nrd-dashboard .section { margin-bottom: 2rem; }
    .nrd-dashboard .section-title { font-size: 1.3rem; font-weight: 700; color: #1a1a2e; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e0e0e0; }
    .nrd-dashboard .section-subtitle { font-size: 0.85rem; color: #666; margin-top: -0.7rem; margin-bottom: 1rem; }

    .nrd-dashboard .card-grid { display: grid; gap: 1rem; margin-bottom: 1rem; }
    .nrd-dashboard .grid-2 { grid-template-columns: repeat(2, 1fr); }
    .nrd-dashboard .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .nrd-dashboard .grid-4 { grid-template-columns: repeat(4, 1fr); }
    .nrd-dashboard .grid-5 { grid-template-columns: repeat(5, 1fr); }
    .nrd-dashboard .grid-6 { grid-template-columns: repeat(6, 1fr); }
    @media (max-width: 768px) { .nrd-dashboard .grid-3,.nrd-dashboard .grid-4,.nrd-dashboard .grid-5,.nrd-dashboard .grid-6 { grid-template-columns: repeat(2, 1fr); } .nrd-dashboard .grid-2 { grid-template-columns: 1fr; } }
    @media (max-width: 480px) { .nrd-dashboard .grid-2,.nrd-dashboard .grid-3,.nrd-dashboard .grid-4,.nrd-dashboard .grid-5,.nrd-dashboard .grid-6 { grid-template-columns: 1fr; } }

    .nrd-dashboard .card { background: white; border-radius: 10px; padding: 1.2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); text-align: center; }
    .nrd-dashboard .card .label { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.3rem; }
    .nrd-dashboard .card .value { font-size: 2rem; font-weight: 700; color: #1a1a2e; }
    .nrd-dashboard .card.hero .value { font-size: 2.5rem; }
    .nrd-dashboard .card.wag { border-left: 4px solid #e74c8b; }
    .nrd-dashboard .card.mag { border-left: 4px solid #3498db; }
    .nrd-dashboard .card.tnt { border-left: 4px solid #2ecc71; }
    .nrd-dashboard .card.special { border-left: 4px solid #f39c12; }
    .nrd-dashboard .card .detail { font-size: 0.75rem; color: #999; margin-top: 0.3rem; }

    .nrd-dashboard .data-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 1rem; }
    .nrd-dashboard .data-table th { background: #1a1a2e; color: white; padding: 0.75rem 1rem; text-align: left; font-size: 0.85rem; font-weight: 600; cursor: pointer; user-select: none; white-space: nowrap; }
    .nrd-dashboard .data-table th:hover { background: #2a2a4e; }
    .nrd-dashboard .data-table th .sort-arrow { margin-left: 4px; font-size: 0.7rem; opacity: 0.5; }
    .nrd-dashboard .data-table th .sort-arrow.active { opacity: 1; }
    .nrd-dashboard .data-table td { padding: 0.6rem 1rem; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }
    .nrd-dashboard .data-table tr:last-child td { border-bottom: none; }
    .nrd-dashboard .data-table tr:nth-child(even) { background: #fafbfc; }
    .nrd-dashboard .data-table .num { text-align: right; font-weight: 600; font-variant-numeric: tabular-nums; }
    .nrd-dashboard .data-table th.num-col { text-align: right; }
    .nrd-dashboard .data-table .total-row { background: #f0f2f5 !important; font-weight: 700; }

    .nrd-dashboard .chart-container { background: white; border-radius: 10px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 1rem; }
    .nrd-dashboard .chart-container canvas { max-height: 400px; }

    .nrd-dashboard .disc-header { display: inline-block; padding: 0.3rem 0.8rem; border-radius: 4px; font-size: 0.85rem; font-weight: 600; color: white; margin-bottom: 0.5rem; margin-right: 0.5rem; }
    .nrd-dashboard .disc-header.wag { background: #e74c8b; }
    .nrd-dashboard .disc-header.mag { background: #3498db; }
    .nrd-dashboard .disc-header.tnt { background: #2ecc71; }

    .nrd-dashboard .filter-bar { margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
    .nrd-dashboard .filter-bar label { font-weight: 600; font-size: 0.9rem; }
    .nrd-dashboard .filter-bar select { padding: 0.4rem 0.8rem; border: 1px solid #ccc; border-radius: 6px; font-size: 0.9rem; background: white; }

    .nrd-dashboard .pill-group { display: flex; gap: 0; margin-bottom: 0.75rem; }
    .nrd-dashboard .pill { padding: 0.5rem 1.2rem; border: 1px solid #ccc; background: white; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.15s; }
    .nrd-dashboard .pill:first-child { border-radius: 6px 0 0 6px; }
    .nrd-dashboard .pill:last-child { border-radius: 0 6px 6px 0; }
    .nrd-dashboard .pill:not(:last-child) { border-right: none; }
    .nrd-dashboard .pill.active { background: #1a1a2e; color: white; border-color: #1a1a2e; }
    .nrd-dashboard .pill:hover:not(.active) { background: #f0f2f5; }

    .nrd-dashboard .level-checks { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem; align-items: center; }
    .nrd-dashboard .level-checks label { font-size: 0.85rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.3rem; }
    .nrd-dashboard .level-checks input[type="checkbox"] { cursor: pointer; accent-color: #1a1a2e; }
    .nrd-dashboard .level-checks .lbl-prefix { font-weight: 600; font-size: 0.85rem; color: #666; margin-right: 0.25rem; }
    .nrd-dashboard .no-data-msg { padding: 2rem; text-align: center; color: #999; font-style: italic; background: white; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 1rem; }

    .nrd-dashboard .chart-stack .chart-container { margin-bottom: 1rem; }
    .nrd-dashboard .chart-stack .chart-container canvas { max-height: 350px; }

    .nrd-dashboard .nrd-loading { text-align: center; padding: 3rem 1rem; }
    .nrd-dashboard .nrd-loading h2 { font-size: 1.4rem; color: #1a1a2e; margin-bottom: 1rem; }
    .nrd-dashboard .loading-bar { width: 300px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin: 0 auto; }
    .nrd-dashboard .loading-bar-fill { height: 100%; background: linear-gradient(135deg, #e74c8b, #3498db); border-radius: 4px; transition: width 0.3s; width: 0%; }
    .nrd-dashboard .loading-status { margin-top: 0.75rem; font-size: 0.85rem; color: #666; }
    .nrd-dashboard .loading-detail { margin-top: 0.3rem; font-size: 0.75rem; color: #999; }

    .nrd-dashboard .nrd-footer { text-align: center; padding: 2rem; color: #999; font-size: 0.8rem; }

    /* Tab bar */
    .nrd-dashboard .nrd-tab-bar { display: flex; gap: 0; border-bottom: 2px solid #e0e0e0; max-width: 1200px; margin: 0 auto; padding: 0; }
    .nrd-dashboard .nrd-tab { padding: 0.75rem 1.5rem; border: none; background: none; font-size: 0.95rem; font-weight: 600; color: #666; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.15s; }
    .nrd-dashboard .nrd-tab.active { color: #1a1a2e; border-bottom-color: #1a1a2e; }
    .nrd-dashboard .nrd-tab:hover:not(.active) { color: #333; background: #f8f8f8; }
</style>

<div class="nrd-dashboard" id="nrd-dashboard">
    <div class="nrd-loading" id="nrd-loading">
        <h2>Loading Competition Data...</h2>
        <div class="loading-bar"><div class="loading-bar-fill" id="nrd-loading-bar-fill"></div></div>
        <div class="loading-status" id="nrd-loading-status">Initializing...</div>
        <div class="loading-detail" id="nrd-loading-detail"></div>
    </div>

    <div id="nrd-content" style="display:none;">
        <div class="nrd-header">
            <h1>NAIGC Nationals 2025</h1>
            <div class="subtitle">Competition Results Dashboard</div>
        </div>

        <!-- TAB BAR -->
        <div class="nrd-tab-bar" id="nrd-tab-bar">
            <button class="nrd-tab active" data-tab="prelims">Prelims</button>
            <button class="nrd-tab" data-tab="finals">Finals</button>
            <button class="nrd-tab" data-tab="combined">Prelims + Finals</button>
        </div>

        <div class="nrd-main">
            <!-- GLOBAL FILTERS -->
            <div class="filter-bar" id="nrd-global-filters">
                <label for="nrd-filter-discipline">Discipline:</label>
                <select id="nrd-filter-discipline">
                    <option value="all">All</option>
                    <option value="WAG">WAG</option>
                    <option value="MAG">MAG</option>
                    <option value="T&T">T&amp;T</option>
                </select>
                <label for="nrd-filter-category">Category:</label>
                <select id="nrd-filter-category">
                    <option value="all">All Categories</option>
                    <option value="Collegiate Women">Collegiate Women</option>
                    <option value="Community Women">Community Women</option>
                    <option value="Collegiate Men">Collegiate Men</option>
                    <option value="Community Men">Community Men</option>
                </select>
            </div>

            <!-- 1. COMPETITION OVERVIEW -->
            <div class="section" id="nrd-section-overview">
                <h2 class="section-title">Competition Overview</h2>
                <div class="card-grid grid-3" id="nrd-overview-hero"></div>
                <div class="card-grid grid-3" id="nrd-overview-discipline"></div>
                <div class="card-grid grid-3" id="nrd-overview-scores"></div>
            </div>

            <!-- 2. SCORE DISTRIBUTIONS -->
            <div class="section">
                <h2 class="section-title">Score Distributions by Apparatus</h2>
                <p class="section-subtitle">Distribution of scores in 0.5-point bins. Stacked by level when multiple levels are selected.</p>
                <div class="pill-group" id="nrd-score-dist-pills"></div>
                <div class="level-checks" id="nrd-score-dist-levels"></div>
                <div class="chart-stack" id="nrd-score-dist-charts"></div>
            </div>

            <!-- 3. START VALUE DISTRIBUTIONS -->
            <div class="section" id="nrd-section-sv">
                <h2 class="section-title">Start Value Distributions</h2>
                <p class="section-subtitle">Distribution of start values (difficulty scores) by apparatus and level</p>
                <div class="pill-group" id="nrd-sv-dist-pills"></div>
                <div class="level-checks" id="nrd-sv-dist-levels"></div>
                <div class="chart-stack" id="nrd-sv-dist-charts"></div>
            </div>

            <!-- 4. SUMMARY STATISTICS -->
            <div class="section">
                <h2 class="section-title">Score Summary Statistics</h2>
                <p class="section-subtitle">Mean, median, standard deviation, min/max for each apparatus by discipline and level</p>
                <div class="pill-group" id="nrd-stats-pills"></div>
                <div class="level-checks" id="nrd-stats-levels"></div>
                <div id="nrd-stats-tables"></div>
            </div>

            <!-- 5. FINALS QUALIFIER ANALYSIS -->
            <div class="section" id="nrd-section-quals">
                <h2 class="section-title">Finals Qualifier Analysis</h2>
                <p class="section-subtitle">Demographics and patterns among athletes who qualified for finals</p>
                <div class="card-grid grid-3" id="nrd-quals-cards"></div>
                <div class="card-grid grid-2" id="nrd-quals-team-cards"></div>
                <div class="chart-container"><canvas id="nrd-chart-quals-category"></canvas></div>
                <div id="nrd-quals-level-table-container"></div>
                <h3 style="font-size:1.1rem; margin:1.5rem 0 0.75rem; color:#1a1a2e;">Qualification Cutoffs</h3>
                <p class="section-subtitle">Lowest prelim score among athletes who advanced to finals, by apparatus and level</p>
                <div class="pill-group" id="nrd-cutoff-pills"></div>
                <div class="level-checks" id="nrd-cutoff-levels"></div>
                <div id="nrd-quals-cutoff-container"></div>
            </div>

            <!-- 6. DIFFICULTY TRENDS -->
            <div class="section" id="nrd-section-difficulty">
                <h2 class="section-title">Apparatus Difficulty by Level</h2>
                <p class="section-subtitle">Average start values by level, showing difficulty progression and level-appropriate calibration. Error bars show &plusmn;1 standard deviation.</p>
                <div class="pill-group" id="nrd-difficulty-pills"></div>
                <div class="chart-container"><canvas id="nrd-chart-difficulty-bars"></canvas></div>
                <div class="chart-container"><canvas id="nrd-chart-difficulty-lines"></canvas></div>
            </div>

            <!-- 7. EXECUTION ANALYSIS -->
            <div class="section" id="nrd-section-execution">
                <h2 class="section-title">Execution Analysis (Score - Start Value)</h2>
                <p class="section-subtitle">Implied execution scores computed as Final Score minus Start Value</p>
                <div class="pill-group" id="nrd-execution-pills"></div>
                <div class="level-checks" id="nrd-execution-levels"></div>
                <div class="chart-container"><canvas id="nrd-chart-execution"></canvas></div>
                <div id="nrd-execution-table-container"></div>
            </div>

            <!-- 8. CROSS-ROUND INSIGHTS (Combined tab only) -->
            <div class="section" id="nrd-section-combined" style="display:none;">
                <h2 class="section-title">Cross-Round Insights: Prelims vs. Finals</h2>
                <p class="section-subtitle">Score changes between preliminary and final rounds for athletes competing in both</p>
                <div class="pill-group" id="nrd-combined-pills"></div>
                <div class="level-checks" id="nrd-combined-levels"></div>
                <div class="card-grid grid-4" id="nrd-combined-delta-cards"></div>
                <div class="chart-container"><canvas id="nrd-chart-combined-delta"></canvas></div>
                <div id="nrd-combined-delta-table"></div>
                <div class="chart-container"><canvas id="nrd-chart-combined-spread"></canvas></div>
            </div>
        </div>

        <div class="nrd-footer">NAIGC Nationals 2025 Competition Results Dashboard</div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
<script>
(function() {
    'use strict';

    function $(id) { return document.getElementById(id); }

    // ============================================================
    // DATA FILES (local xlsx)
    // ============================================================
    var DATA_FILES = {
        wag_prelims: 'data/wag_prelims.xlsx',
        wag_finals:  'data/wag_finals.xlsx',
        mag_prelims: 'data/mag_prelims.xlsx',
        mag_finals:  'data/mag_finals.xlsx',
        tnt_raw:     'data/tnt_raw.xlsx',
    };

    var FILE_LABELS = {
        wag_prelims: 'WAG Prelims',
        wag_finals:  'WAG Finals',
        mag_prelims: 'MAG Prelims',
        mag_finals:  'MAG Finals',
        tnt_raw:     'T&T Results',
    };

    // ============================================================
    // CONSTANTS
    // ============================================================
    var COLORS = {
        wag: '#e74c8b', mag: '#3498db', tnt: '#2ecc71', special: '#f39c12',
        wagLight: 'rgba(231,76,139,0.7)', magLight: 'rgba(52,152,219,0.7)',
        tntLight: 'rgba(46,204,113,0.7)', specialLight: 'rgba(243,156,18,0.7)',
    };

    var WAG_APPARATUS = [
        { key: 'VT_Score', svKey: 'VT_SV', placeKey: 'Vault Place', label: 'Vault', short: 'VT' },
        { key: 'UB_Score', svKey: 'UB_SV', placeKey: 'Bars Place', label: 'Bars', short: 'UB' },
        { key: 'BM_Score', svKey: 'BM_SV', placeKey: 'Beam Place', label: 'Beam', short: 'BB' },
        { key: 'FX_Score', svKey: 'FX_SV', placeKey: 'Floor Place', label: 'Floor', short: 'FX' },
        { key: 'AA_Score', svKey: null, placeKey: 'AA Place', label: 'All-Around', short: 'AA' },
    ];
    var MAG_APPARATUS = [
        { key: 'FX_Score', svKey: 'FX_SV', placeKey: 'Floor Place', label: 'Floor', short: 'FX' },
        { key: 'PH_Score', svKey: 'PH_SV', placeKey: 'Pommel Place', label: 'Pommel Horse', short: 'PH' },
        { key: 'SR_Score', svKey: 'SR_SV', placeKey: 'Rings Place', label: 'Rings', short: 'SR' },
        { key: 'VT_Score', svKey: 'VT_SV', placeKey: 'Vault Place', label: 'Vault', short: 'VT' },
        { key: 'PB_Score', svKey: 'PB_SV', placeKey: 'PBars Place', label: 'P-Bars', short: 'PB' },
        { key: 'HB_Score', svKey: 'HB_SV', placeKey: 'HighBar Place', label: 'High Bar', short: 'HB' },
        { key: 'AA_Score', svKey: null, placeKey: 'AA Place', label: 'All-Around', short: 'AA' },
    ];
    var TNT_APPARATUS = [
        { key: 'Tumbling_Score', svKey: null, placeKey: 'Tumbling Place', label: 'Tumbling', short: 'TU' },
        { key: 'Trampoline_Score', svKey: null, placeKey: 'Trampoline Place', label: 'Trampoline', short: 'TR' },
        { key: 'Synch_Trampoline_Score', svKey: null, placeKey: 'Synch Trampoline Place', label: 'Synchro', short: 'SY' },
        { key: 'DMT_Score', svKey: null, placeKey: 'DMT Place', label: 'DMT', short: 'DMT' },
    ];

    var WAG_LEVELS = ['XS', 'XP', 'XD', 'L9', 'Open'];
    var MAG_LEVELS = ['Dev', 'Int', 'Adv'];
    var TNT_LEVELS = ['NF', 'IF', 'HF'];

    var WAG_INDIV_KEYS = ['VT_Score', 'UB_Score', 'BM_Score', 'FX_Score'];
    var MAG_INDIV_KEYS = ['FX_Score', 'PH_Score', 'SR_Score', 'VT_Score', 'PB_Score', 'HB_Score'];

    // ============================================================
    // STATE
    // ============================================================
    var charts = [];
    var levelCheckState = {};
    var activeTab = 'prelims'; // 'prelims' | 'finals' | 'combined'

    // Per-tab data stores (populated by processRawData)
    var prelimsData = {};  // { wag: [], mag: [], tnt: [] }
    var finalsData = {};   // { wag: [], mag: [], tnt: [] }
    var combinedData = {}; // { wag: [], mag: [], tnt: [] }
    var teamCounts = {};
    var finalsAthleteKeys = { wag: new Set(), mag: new Set() };
    var svLookup = {};

    // ============================================================
    // DATA FETCHING
    // ============================================================
    async function fetchXLSX(url) {
        var response = await fetch(url);
        if (!response.ok) throw new Error('HTTP ' + response.status + ' for ' + url);
        var arrayBuffer = await response.arrayBuffer();
        var workbook = XLSX.read(arrayBuffer, { type: 'array' });
        var sheetName = workbook.SheetNames[0];
        return XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
    }

    // ============================================================
    // DATA PROCESSING
    // ============================================================
    function processRawData(rawData) {
        // Clean rows: filter nulls, derive Placement Category
        function cleanRows(rows) {
            return (rows || []).filter(function(r) {
                return r.CompLevel != null && r.CompLevel !== '';
            }).map(function(r) {
                // Derive Placement Category from Student + Gender
                if (!r['Placement Category']) {
                    var isStudent = r.Student === true || r.Student === 'TRUE' || r.Student === 'true' || r.Student === 1;
                    var gender = (r.Gender || '').toString().toUpperCase();
                    var catPrefix = isStudent ? 'Collegiate' : 'Community';
                    var catSuffix = gender === 'F' ? 'Women' : gender === 'M' ? 'Men' : 'Other';
                    r['Placement Category'] = catPrefix + ' ' + catSuffix;
                }
                return r;
            });
        }

        var wagPrelims = cleanRows(rawData.wag_prelims);
        var wagFinals = cleanRows(rawData.wag_finals);
        var magPrelims = cleanRows(rawData.mag_prelims);
        var magFinals = cleanRows(rawData.mag_finals);
        var tntRaw = cleanRows(rawData.tnt_raw);

        // Populate per-tab data
        prelimsData = { wag: wagPrelims, mag: magPrelims, tnt: tntRaw };
        finalsData = { wag: wagFinals, mag: magFinals, tnt: [] };
        combinedData = {
            wag: wagPrelims.concat(wagFinals),
            mag: magPrelims.concat(magFinals),
            tnt: tntRaw
        };

        // Team counts (unique Club_Name values)
        teamCounts = {
            wag_prelims: new Set(wagPrelims.map(function(r) { return r.Club_Name; }).filter(Boolean)).size,
            mag_prelims: new Set(magPrelims.map(function(r) { return r.Club_Name; }).filter(Boolean)).size,
            wag_finals: new Set(wagFinals.map(function(r) { return r.Club_Name; }).filter(Boolean)).size,
            mag_finals: new Set(magFinals.map(function(r) { return r.Club_Name; }).filter(Boolean)).size,
        };

        // Finals athlete keys (for qualifier analysis)
        finalsAthleteKeys.wag = new Set(wagFinals.map(athleteKey));
        finalsAthleteKeys.mag = new Set(magFinals.map(athleteKey));

        // Build SV lookup from all score data
        svLookup = {};
        [wagPrelims, wagFinals, magPrelims, magFinals].forEach(function(rows) {
            buildSVLookup(rows);
        });
    }

    // ============================================================
    // TAB-AWARE DATA ACCESS
    // ============================================================
    function getScoreData(disc) {
        var key = disc === 'WAG' ? 'wag' : disc === 'MAG' ? 'mag' : 'tnt';
        switch (activeTab) {
            case 'prelims': return prelimsData[key] || [];
            case 'finals': return finalsData[key] || [];
            case 'combined': return combinedData[key] || [];
            default: return [];
        }
    }

    // ============================================================
    // UTILITIES
    // ============================================================
    function fmt(n) { return typeof n === 'number' ? n.toLocaleString() : n; }
    function pct(n, d) { return d > 0 ? (n / d * 100).toFixed(1) + '%' : '\u2014'; }
    function f3(n) { return typeof n === 'number' ? n.toFixed(3) : '\u2014'; }
    function athleteKey(row) { return row.Athlete_Email || (row.FirstName + '|' + row.LastName); }

    function getValidScores(rows, scoreCol) {
        var scores = [];
        rows.forEach(function(r) { var v = parseFloat(r[scoreCol]); if (v && v > 0) scores.push(v); });
        return scores;
    }

    function hasCompleteAA(row, disc) {
        var keys = disc === 'WAG' ? WAG_INDIV_KEYS : MAG_INDIV_KEYS;
        for (var i = 0; i < keys.length; i++) {
            var v = parseFloat(row[keys[i]]);
            if (!v || v <= 0) return false;
        }
        return true;
    }

    function computeStats(values) {
        if (!values.length) return null;
        var sorted = values.slice().sort(function(a, b) { return a - b; });
        var n = sorted.length;
        var sum = sorted.reduce(function(a, b) { return a + b; }, 0);
        var mean = sum / n;
        var median = n % 2 ? sorted[Math.floor(n / 2)] : (sorted[Math.floor(n / 2) - 1] + sorted[Math.floor(n / 2)]) / 2;
        var variance = sorted.reduce(function(s, v) { return s + Math.pow(v - mean, 2); }, 0) / n;
        var stdDev = Math.sqrt(variance);
        return { n: n, mean: mean, median: median, stdDev: stdDev, min: sorted[0], max: sorted[n - 1] };
    }

    function buildHistogram(values, binWidth) {
        binWidth = binWidth || 0.5;
        if (!values.length) return { labels: [], counts: [] };
        var min = Math.floor(Math.min.apply(null, values) / binWidth) * binWidth;
        var max = Math.ceil(Math.max.apply(null, values) / binWidth) * binWidth;
        var labels = [], counts = [];
        for (var edge = min; edge < max; edge += binWidth) {
            labels.push(edge.toFixed(1));
            var e = edge;
            counts.push(values.filter(function(v) { return v >= e && v < e + binWidth; }).length);
        }
        return { labels: labels, counts: counts };
    }

    function levelsForDisc(disc) { return disc === 'WAG' ? WAG_LEVELS : disc === 'MAG' ? MAG_LEVELS : disc === 'T&T' ? TNT_LEVELS : []; }
    function apparatusForDisc(disc) { return disc === 'WAG' ? WAG_APPARATUS : disc === 'MAG' ? MAG_APPARATUS : disc === 'T&T' ? TNT_APPARATUS : []; }
    function discColor(disc) { return COLORS[disc === 'WAG' ? 'wag' : disc === 'MAG' ? 'mag' : 'tnt']; }
    function discColorLight(disc) { return COLORS[disc === 'WAG' ? 'wagLight' : disc === 'MAG' ? 'magLight' : 'tntLight']; }
    function discClass(disc) { return disc === 'WAG' ? 'wag' : disc === 'MAG' ? 'mag' : 'tnt'; }

    function levelShade(disc, levelIdx, totalLevels) {
        var base = discColor(disc);
        var opacity = 0.4 + (levelIdx / Math.max(totalLevels - 1, 1)) * 0.5;
        var r = parseInt(base.slice(1, 3), 16), g = parseInt(base.slice(3, 5), 16), b = parseInt(base.slice(5, 7), 16);
        return 'rgba(' + r + ',' + g + ',' + b + ',' + opacity + ')';
    }

    function makeCard(label, value, classes) {
        var d = document.createElement('div');
        d.className = 'card ' + (classes || '');
        d.innerHTML = '<div class="label">' + label + '</div><div class="value">' + fmt(value) + '</div>';
        return d;
    }
    function makeCardDetail(label, value, detail, classes) {
        var d = document.createElement('div');
        d.className = 'card ' + (classes || '');
        d.innerHTML = '<div class="label">' + label + '</div><div class="value">' + fmt(value) + '</div><div class="detail">' + detail + '</div>';
        return d;
    }

    function destroyAllCharts() { charts.forEach(function(c) { try { c.destroy(); } catch(e) {} }); charts = []; }

    function makeSortable(table) {
        var headers = table.querySelectorAll('thead th');
        var currentSort = { col: -1, asc: true };
        headers.forEach(function(th, idx) {
            var arrow = document.createElement('span');
            arrow.className = 'sort-arrow'; arrow.textContent = ' \u25B2';
            th.appendChild(arrow);
            th.addEventListener('click', function() {
                var tbody = table.querySelector('tbody');
                var rows = Array.from(tbody.querySelectorAll('tr')).filter(function(r) { return !r.classList.contains('total-row'); });
                var totalRow = tbody.querySelector('tr.total-row');
                var asc = currentSort.col === idx ? !currentSort.asc : true;
                currentSort = { col: idx, asc: asc };
                headers.forEach(function(h) { var a = h.querySelector('.sort-arrow'); if (a) { a.className = 'sort-arrow'; a.textContent = ' \u25B2'; } });
                arrow.className = 'sort-arrow active'; arrow.textContent = asc ? ' \u25B2' : ' \u25BC';
                rows.sort(function(a, b) {
                    var va = a.cells[idx] ? a.cells[idx].textContent.trim().replace(/,/g, '') : '';
                    var vb = b.cells[idx] ? b.cells[idx].textContent.trim().replace(/,/g, '') : '';
                    var na = parseFloat(va), nb = parseFloat(vb);
                    if (!isNaN(na) && !isNaN(nb)) return asc ? na - nb : nb - na;
                    return asc ? va.localeCompare(vb) : vb.localeCompare(va);
                });
                rows.forEach(function(r) { tbody.appendChild(r); });
                if (totalRow) tbody.appendChild(totalRow);
            });
        });
    }

    function buildSVLookup(rows) {
        (rows || []).forEach(function(row) {
            var key = athleteKey(row);
            if (!svLookup[key]) svLookup[key] = {};
            var entry = svLookup[key];
            entry.CompLevel = row.CompLevel;
            ['VT_SV','UB_SV','BM_SV','FX_SV','PH_SV','SR_SV','PB_SV','HB_SV'].forEach(function(col) {
                var v = parseFloat(row[col]); if (v && v > 0) entry[col] = v;
            });
        });
    }

    function getFilteredRows(rows) {
        var cat = $('nrd-filter-category').value;
        var filtered = rows.slice();
        if (cat !== 'all') filtered = filtered.filter(function(r) { return r['Placement Category'] === cat; });
        return filtered;
    }

    // ============================================================
    // REUSABLE: LEVEL CHECKBOX UI
    // ============================================================
    function buildLevelCheckboxes(sectionKey, disc, containerEl, onChange) {
        containerEl.innerHTML = '';
        var levels = levelsForDisc(disc);
        if (!levels.length) return [];
        var stateKey = sectionKey + '_' + disc;
        if (!levelCheckState[stateKey]) {
            var defaults = {};
            levels.forEach(function(lev) {
                defaults[lev] = !(disc === 'WAG' && lev === 'Open');
            });
            levelCheckState[stateKey] = defaults;
        }
        var state = levelCheckState[stateKey];
        var prefix = document.createElement('span');
        prefix.className = 'lbl-prefix';
        prefix.textContent = 'Levels:';
        containerEl.appendChild(prefix);
        levels.forEach(function(lev) {
            var lbl = document.createElement('label');
            var cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.checked = !!state[lev];
            cb.addEventListener('change', function() {
                state[lev] = cb.checked;
                onChange();
            });
            lbl.appendChild(cb);
            lbl.appendChild(document.createTextNode(' ' + lev));
            containerEl.appendChild(lbl);
        });
        return getCheckedLevels(sectionKey, disc);
    }

    function getCheckedLevels(sectionKey, disc) {
        var stateKey = sectionKey + '_' + disc;
        var state = levelCheckState[stateKey];
        if (!state) return levelsForDisc(disc);
        return levelsForDisc(disc).filter(function(lev) { return state[lev]; });
    }

    // ============================================================
    // REUSABLE: PILL BUILDER
    // ============================================================
    function buildPills(pillGroup, disciplines, activeDisc, renderFn) {
        pillGroup.innerHTML = '';
        disciplines.forEach(function(disc) {
            var pill = document.createElement('div');
            pill.className = 'pill' + (disc === activeDisc ? ' active' : '');
            pill.textContent = disc;
            pill.dataset.disc = disc;
            pill.addEventListener('click', function() { renderFn(disc); });
            pillGroup.appendChild(pill);
        });
    }

    // ============================================================
    // SECTION VISIBILITY
    // ============================================================
    function updateSectionVisibility() {
        var qualsSection = $('nrd-section-quals');
        var combinedSection = $('nrd-section-combined');
        if (qualsSection) qualsSection.style.display = (activeTab === 'prelims') ? 'none' : '';
        if (combinedSection) combinedSection.style.display = (activeTab === 'combined') ? '' : 'none';
    }

    // ============================================================
    // SECTION RENDERERS
    // ============================================================

    function renderOverview() {
        var hero = $('nrd-overview-hero'), discCards = $('nrd-overview-discipline'), scoreCards = $('nrd-overview-scores');
        hero.innerHTML = ''; discCards.innerHTML = ''; scoreCards.innerHTML = '';

        var wagData = getScoreData('WAG'), magData = getScoreData('MAG'), tntData = getScoreData('T&T');
        var uniqueAthletes = new Set(), wagAthletes = new Set(), magAthletes = new Set(), tntAthletes = new Set();
        wagData.forEach(function(r) { var k = athleteKey(r); uniqueAthletes.add(k); wagAthletes.add(k); });
        magData.forEach(function(r) { var k = athleteKey(r); uniqueAthletes.add(k); magAthletes.add(k); });
        tntData.forEach(function(r) { var k = athleteKey(r); uniqueAthletes.add(k); tntAthletes.add(k); });

        var wagFinalistsCount = finalsAthleteKeys.wag.size;
        var magFinalistsCount = finalsAthleteKeys.mag.size;

        var tabTeams = 0;
        if (activeTab === 'prelims') tabTeams = teamCounts.wag_prelims + teamCounts.mag_prelims;
        else if (activeTab === 'finals') tabTeams = teamCounts.wag_finals + teamCounts.mag_finals;
        else tabTeams = new Set(
            (combinedData.wag || []).map(function(r) { return r.Club_Name; }).filter(Boolean).concat(
            (combinedData.mag || []).map(function(r) { return r.Club_Name; }).filter(Boolean))
        ).size;

        hero.appendChild(makeCard('Total Athletes', uniqueAthletes.size, 'hero'));
        hero.appendChild(makeCard('Clubs Represented', tabTeams, 'hero'));
        hero.appendChild(makeCard('Data Files Loaded', Object.keys(DATA_FILES).length, 'hero'));

        var wagDetail = activeTab !== 'prelims' ? wagFinalistsCount + ' finalists' : '';
        var magDetail = activeTab !== 'prelims' ? magFinalistsCount + ' finalists' : '';
        discCards.appendChild(makeCardDetail('WAG Athletes', wagAthletes.size, wagDetail, 'wag'));
        discCards.appendChild(makeCardDetail('MAG Athletes', magAthletes.size, magDetail, 'mag'));
        discCards.appendChild(makeCardDetail('T&T Athletes', tntAthletes.size, '', 'tnt'));

        // Average AA scores
        var wagAANoOpen = wagData.filter(function(r) { return r.CompLevel !== 'Open' && hasCompleteAA(r, 'WAG'); });
        var wagAAOpen = wagData.filter(function(r) { return r.CompLevel === 'Open' && hasCompleteAA(r, 'WAG'); });
        var magAAComplete = magData.filter(function(r) { return hasCompleteAA(r, 'MAG'); });
        var wagAAScores = getValidScores(wagAANoOpen, 'AA_Score');
        var wagOpenAAScores = getValidScores(wagAAOpen, 'AA_Score');
        var magAAScores = getValidScores(magAAComplete, 'AA_Score');
        var wagAvgAA = wagAAScores.length ? wagAAScores.reduce(function(a,b){return a+b;},0) / wagAAScores.length : 0;
        var wagOpenAvgAA = wagOpenAAScores.length ? wagOpenAAScores.reduce(function(a,b){return a+b;},0) / wagOpenAAScores.length : 0;
        var magAvgAA = magAAScores.length ? magAAScores.reduce(function(a,b){return a+b;},0) / magAAScores.length : 0;
        scoreCards.appendChild(makeCardDetail('WAG Avg AA (excl. Open)', f3(wagAvgAA), 'n=' + wagAAScores.length, 'wag'));
        scoreCards.appendChild(makeCardDetail('WAG Open Avg AA', f3(wagOpenAvgAA), 'n=' + wagOpenAAScores.length, 'wag'));
        scoreCards.appendChild(makeCardDetail('MAG Avg AA', f3(magAvgAA), 'n=' + magAAScores.length, 'mag'));
    }

    function renderScoreDistributions() {
        var container = $('nrd-score-dist-charts'), pillGroup = $('nrd-score-dist-pills'), levelContainer = $('nrd-score-dist-levels');
        container.innerHTML = ''; pillGroup.innerHTML = ''; levelContainer.innerHTML = '';
        var disciplines = ['WAG', 'MAG', 'T&T'], activeDisc = 'WAG', sectionCharts = [];
        function render(disc) {
            activeDisc = disc;
            sectionCharts.forEach(function(c) { try { c.destroy(); } catch(e) {} }); sectionCharts = [];
            container.innerHTML = '';
            pillGroup.querySelectorAll('.pill').forEach(function(p) { p.classList.toggle('active', p.dataset.disc === disc); });
            var checkedLevels = buildLevelCheckboxes('score-dist', disc, levelContainer, function() { render(disc); });
            if (!checkedLevels.length) { container.innerHTML = '<div class="no-data-msg">Please select at least one level to display data.</div>'; return; }
            var apparatus = apparatusForDisc(disc);
            var allRows = getFilteredRows(getScoreData(disc));
            if (!allRows.length) { container.innerHTML = '<div class="no-data-msg">No data available for ' + disc + ' on this tab.</div>'; return; }
            var rows = allRows.filter(function(r) { return checkedLevels.indexOf(r.CompLevel) !== -1; });
            apparatus.forEach(function(app) {
                var appRows = rows;
                if (app.short === 'AA') { appRows = rows.filter(function(r) { return hasCompleteAA(r, disc); }); }
                var chartDiv = document.createElement('div'); chartDiv.className = 'chart-container';
                var canvas = document.createElement('canvas'); chartDiv.appendChild(canvas); container.appendChild(chartDiv);
                if (checkedLevels.length === 1) {
                    var scores = getValidScores(appRows, app.key), hist = buildHistogram(scores);
                    var chart = new Chart(canvas, { type: 'bar', data: { labels: hist.labels, datasets: [{ label: checkedLevels[0], data: hist.counts, backgroundColor: discColorLight(disc), borderRadius: 2 }] }, options: { responsive: true, plugins: { title: { display: true, text: app.label + ' (' + app.short + ') \u2014 ' + checkedLevels[0], font: { size: 14 } }, legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Athletes' }, ticks: { precision: 0 } }, x: { title: { display: true, text: 'Score' } } } } });
                    charts.push(chart); sectionCharts.push(chart);
                } else {
                    var allScores = getValidScores(appRows, app.key), hist = buildHistogram(allScores);
                    var datasets = checkedLevels.map(function(lev, i) {
                        var levRows = appRows.filter(function(r) { return r.CompLevel === lev; });
                        var levScores = getValidScores(levRows, app.key);
                        var counts = hist.labels.map(function(label) { var edge = parseFloat(label); return levScores.filter(function(v) { return v >= edge && v < edge + 0.5; }).length; });
                        return { label: lev, data: counts, backgroundColor: levelShade(disc, i, checkedLevels.length), borderRadius: 1 };
                    });
                    var chart = new Chart(canvas, { type: 'bar', data: { labels: hist.labels, datasets: datasets }, options: { responsive: true, plugins: { title: { display: true, text: app.label + ' (' + app.short + ')', font: { size: 14 } }, legend: { display: true, position: 'top', labels: { boxWidth: 12, font: { size: 11 } } } }, scales: { y: { beginAtZero: true, stacked: true, title: { display: true, text: 'Athletes' }, ticks: { precision: 0 } }, x: { stacked: true, title: { display: true, text: 'Score' } } } } });
                    charts.push(chart); sectionCharts.push(chart);
                }
            });
        }
        buildPills(pillGroup, disciplines, activeDisc, render);
        render(activeDisc);
    }

    function renderSVDistributions() {
        var container = $('nrd-sv-dist-charts'), pillGroup = $('nrd-sv-dist-pills'), levelContainer = $('nrd-sv-dist-levels');
        container.innerHTML = ''; pillGroup.innerHTML = ''; levelContainer.innerHTML = '';
        var disciplines = ['WAG', 'MAG'], activeDisc = 'WAG', svSecCharts = [];
        function render(disc) {
            activeDisc = disc;
            svSecCharts.forEach(function(c) { try { c.destroy(); } catch(e) {} }); svSecCharts = [];
            container.innerHTML = '';
            pillGroup.querySelectorAll('.pill').forEach(function(p) { p.classList.toggle('active', p.dataset.disc === disc); });
            var checkedLevels = buildLevelCheckboxes('sv-dist', disc, levelContainer, function() { render(disc); });
            if (!checkedLevels.length) { container.innerHTML = '<div class="no-data-msg">Please select at least one level to display data.</div>'; return; }
            var apparatus = apparatusForDisc(disc).filter(function(a) { return a.svKey; });
            var allRows = getScoreData(disc);
            if (!allRows.length) { container.innerHTML = '<div class="no-data-msg">No data available for ' + disc + ' on this tab.</div>'; return; }
            var rows = allRows.filter(function(r) { return checkedLevels.indexOf(r.CompLevel) !== -1; });
            apparatus.forEach(function(app) {
                var chartDiv = document.createElement('div'); chartDiv.className = 'chart-container';
                var canvas = document.createElement('canvas'); chartDiv.appendChild(canvas); container.appendChild(chartDiv);
                if (checkedLevels.length === 1) {
                    var allSVs = []; rows.forEach(function(r) { var v = parseFloat(r[app.svKey]); if (v > 0) allSVs.push(v); });
                    var meanSV = allSVs.length ? allSVs.reduce(function(a,b){return a+b;},0)/allSVs.length : 0;
                    var hist = buildHistogram(allSVs, 0.5);
                    var titleText = meanSV > 0 ? app.label + ' SV (' + app.short + ') \u2014 ' + checkedLevels[0] + ' \u2014 Mean: ' + meanSV.toFixed(3) : app.label + ' SV (' + app.short + ')';
                    var chart = new Chart(canvas, { type: 'bar', data: { labels: hist.labels, datasets: [{ label: checkedLevels[0], data: hist.counts, backgroundColor: discColorLight(disc), borderRadius: 2 }] }, options: { responsive: true, plugins: { title: { display: true, text: titleText, font: { size: 14 } }, legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } }, x: { title: { display: true, text: 'Start Value' } } } } });
                    charts.push(chart); svSecCharts.push(chart);
                } else {
                    var allSVs = []; rows.forEach(function(r) { var v = parseFloat(r[app.svKey]); if (v > 0) allSVs.push(v); });
                    var meanSV = allSVs.length ? allSVs.reduce(function(a,b){return a+b;},0)/allSVs.length : 0;
                    var hist = buildHistogram(allSVs, 0.5);
                    var datasets = checkedLevels.map(function(lev, i) {
                        var levRows = rows.filter(function(r) { return r.CompLevel === lev; });
                        var levSVs = []; levRows.forEach(function(r) { var v = parseFloat(r[app.svKey]); if (v > 0) levSVs.push(v); });
                        var counts = hist.labels.map(function(label) { var edge = parseFloat(label); return levSVs.filter(function(v) { return v >= edge && v < edge + 0.5; }).length; });
                        return { label: lev, data: counts, backgroundColor: levelShade(disc, i, checkedLevels.length), borderRadius: 1 };
                    });
                    var titleText = meanSV > 0 ? app.label + ' SV (' + app.short + ') \u2014 Mean: ' + meanSV.toFixed(3) : app.label + ' SV (' + app.short + ')';
                    var chart = new Chart(canvas, { type: 'bar', data: { labels: hist.labels, datasets: datasets }, options: { responsive: true, plugins: { title: { display: true, text: titleText, font: { size: 14 } }, legend: { display: true, position: 'top', labels: { boxWidth: 12, font: { size: 11 } } } }, scales: { y: { beginAtZero: true, stacked: true, ticks: { precision: 0 } }, x: { stacked: true, title: { display: true, text: 'Start Value' } } } } });
                    charts.push(chart); svSecCharts.push(chart);
                }
            });
        }
        buildPills(pillGroup, disciplines, activeDisc, render);
        render(activeDisc);
    }

    function renderSummaryStats() {
        var container = $('nrd-stats-tables'), pillGroup = $('nrd-stats-pills'), levelContainer = $('nrd-stats-levels');
        container.innerHTML = ''; pillGroup.innerHTML = ''; levelContainer.innerHTML = '';
        var disciplines = ['WAG', 'MAG', 'T&T'], activeDisc = 'WAG';
        function render(disc) {
            activeDisc = disc; container.innerHTML = '';
            pillGroup.querySelectorAll('.pill').forEach(function(p) { p.classList.toggle('active', p.dataset.disc === disc); });
            var checkedLevels = buildLevelCheckboxes('stats', disc, levelContainer, function() { render(disc); });
            if (!checkedLevels.length) { container.innerHTML = '<div class="no-data-msg">Please select at least one level to display data.</div>'; return; }
            var apparatus = apparatusForDisc(disc);
            var allRows = getFilteredRows(getScoreData(disc));
            if (!allRows.length) { container.innerHTML = '<div class="no-data-msg">No data available for ' + disc + ' on this tab.</div>'; return; }
            var table = document.createElement('table'); table.className = 'data-table';
            table.innerHTML = '<thead><tr><th>Apparatus</th><th>Level</th><th class="num-col">N</th><th class="num-col">Mean</th><th class="num-col">Median</th><th class="num-col">Std Dev</th><th class="num-col">Min</th><th class="num-col">Max</th></tr></thead><tbody></tbody>';
            var tbody = table.querySelector('tbody');
            apparatus.forEach(function(app) { checkedLevels.forEach(function(lev) {
                var levRows = allRows.filter(function(r) { return r.CompLevel === lev; });
                if (app.short === 'AA') { levRows = levRows.filter(function(r) { return hasCompleteAA(r, disc); }); }
                var scores = getValidScores(levRows, app.key), stats = computeStats(scores);
                if (!stats) return;
                var tr = document.createElement('tr');
                tr.innerHTML = '<td>' + app.label + '</td><td>' + lev + '</td><td class="num">' + stats.n + '</td><td class="num">' + f3(stats.mean) + '</td><td class="num">' + f3(stats.median) + '</td><td class="num">' + f3(stats.stdDev) + '</td><td class="num">' + f3(stats.min) + '</td><td class="num">' + f3(stats.max) + '</td>';
                tbody.appendChild(tr);
            }); });
            container.appendChild(table); makeSortable(table);
        }
        buildPills(pillGroup, disciplines, activeDisc, render);
        render(activeDisc);
    }

    function renderQualifierAnalysis() {
        if (activeTab === 'prelims') return;

        var cardsEl = $('nrd-quals-cards'); cardsEl.innerHTML = '';
        var teamCardsEl = $('nrd-quals-team-cards'); teamCardsEl.innerHTML = '';

        // Finalists = athletes who appear in finals data
        var wagPrelims = prelimsData.wag || [];
        var magPrelims = prelimsData.mag || [];
        var wagFinals = finalsData.wag || [];
        var magFinals = finalsData.mag || [];

        var wagQualSet = finalsAthleteKeys.wag;
        var magQualSet = finalsAthleteKeys.mag;

        cardsEl.appendChild(makeCard('WAG Finalists', wagQualSet.size, 'wag'));
        cardsEl.appendChild(makeCard('MAG Finalists', magQualSet.size, 'mag'));
        cardsEl.appendChild(makeCardDetail('Overall Qualification Rate',
            pct(wagQualSet.size + magQualSet.size, wagPrelims.length + magPrelims.length),
            (wagQualSet.size + magQualSet.size) + ' of ' + (wagPrelims.length + magPrelims.length) + ' athletes'));

        teamCardsEl.appendChild(makeCardDetail('WAG Clubs (Prelims)', teamCounts.wag_prelims, teamCounts.wag_finals + ' in finals', 'wag'));
        teamCardsEl.appendChild(makeCardDetail('MAG Clubs (Prelims)', teamCounts.mag_prelims, teamCounts.mag_finals + ' in finals', 'mag'));

        // Category chart - who qualified from which category
        var catCounts = {};
        wagPrelims.forEach(function(r) {
            if (!wagQualSet.has(athleteKey(r))) return;
            var c = r['Placement Category'] || 'Unknown';
            if (!catCounts[c]) catCounts[c] = { wag: 0, mag: 0 };
            catCounts[c].wag++;
        });
        magPrelims.forEach(function(r) {
            if (!magQualSet.has(athleteKey(r))) return;
            var c = r['Placement Category'] || 'Unknown';
            if (!catCounts[c]) catCounts[c] = { wag: 0, mag: 0 };
            catCounts[c].mag++;
        });
        var catLabels = Object.keys(catCounts).sort();
        if (catLabels.length > 0) {
            var catChart = new Chart($('nrd-chart-quals-category'), { type: 'bar', data: { labels: catLabels, datasets: [{ label: 'WAG', data: catLabels.map(function(c) { return catCounts[c].wag; }), backgroundColor: COLORS.wagLight, borderRadius: 3 }, { label: 'MAG', data: catLabels.map(function(c) { return catCounts[c].mag; }), backgroundColor: COLORS.magLight, borderRadius: 3 }] }, options: { responsive: true, plugins: { title: { display: true, text: 'Finals Qualifiers by Category', font: { size: 14 } } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } } });
            charts.push(catChart);
        }

        // Level table: prelims count vs finals count per level
        var lvlContainer = $('nrd-quals-level-table-container'); lvlContainer.innerHTML = '';
        var levelTable = document.createElement('table'); levelTable.className = 'data-table';
        levelTable.innerHTML = '<thead><tr><th>Discipline</th><th>Level</th><th class="num-col">Prelims</th><th class="num-col">Finalists</th><th class="num-col">Rate</th></tr></thead><tbody></tbody>';
        var ltbody = levelTable.querySelector('tbody');
        [{ disc: 'WAG', prelims: wagPrelims, qualSet: wagQualSet, levels: WAG_LEVELS },
         { disc: 'MAG', prelims: magPrelims, qualSet: magQualSet, levels: MAG_LEVELS }].forEach(function(d) {
            d.levels.forEach(function(lev) {
                var pLev = d.prelims.filter(function(r) { return r.CompLevel === lev; });
                var pCount = new Set(pLev.map(athleteKey)).size;
                var fCount = 0;
                pLev.forEach(function(r) { if (d.qualSet.has(athleteKey(r))) fCount++; });
                var tr = document.createElement('tr');
                tr.innerHTML = '<td>' + d.disc + '</td><td>' + lev + '</td><td class="num">' + pCount + '</td><td class="num">' + fCount + '</td><td class="num">' + pct(fCount, pCount) + '</td>';
                ltbody.appendChild(tr);
            });
        });
        lvlContainer.appendChild(levelTable); makeSortable(levelTable);

        // Cutoffs: lowest prelim score among athletes who made finals
        var cutoffPillGroup = $('nrd-cutoff-pills'), cutoffLevelContainer = $('nrd-cutoff-levels');
        var cutoffContainer = $('nrd-quals-cutoff-container');
        cutoffPillGroup.innerHTML = ''; cutoffLevelContainer.innerHTML = ''; cutoffContainer.innerHTML = '';
        var cutoffActiveDisc = 'WAG';
        function renderCutoffs(disc) {
            cutoffActiveDisc = disc; cutoffContainer.innerHTML = '';
            cutoffPillGroup.querySelectorAll('.pill').forEach(function(p) { p.classList.toggle('active', p.dataset.disc === disc); });
            var checkedLevels = buildLevelCheckboxes('cutoffs', disc, cutoffLevelContainer, function() { renderCutoffs(disc); });
            if (!checkedLevels.length) { cutoffContainer.innerHTML = '<div class="no-data-msg">Please select at least one level.</div>'; return; }
            var prelims = disc === 'WAG' ? wagPrelims : magPrelims;
            var qualSet = disc === 'WAG' ? wagQualSet : magQualSet;
            var apparatus = apparatusForDisc(disc);
            var cutoffTable = document.createElement('table'); cutoffTable.className = 'data-table';
            cutoffTable.innerHTML = '<thead><tr><th>Level</th><th>Event</th><th class="num-col">Cutoff Score</th><th class="num-col"># Qualifiers</th></tr></thead><tbody></tbody>';
            var ctb = cutoffTable.querySelector('tbody');
            checkedLevels.forEach(function(lev) {
                var qualifiedAtLevel = prelims.filter(function(r) { return r.CompLevel === lev && qualSet.has(athleteKey(r)); });
                apparatus.forEach(function(app) {
                    var scores = getValidScores(qualifiedAtLevel, app.key);
                    if (!scores.length) return;
                    var minScore = Math.min.apply(null, scores);
                    var tr = document.createElement('tr');
                    tr.innerHTML = '<td>' + lev + '</td><td>' + app.label + '</td><td class="num">' + f3(minScore) + '</td><td class="num">' + scores.length + '</td>';
                    ctb.appendChild(tr);
                });
            });
            cutoffContainer.appendChild(cutoffTable); makeSortable(cutoffTable);
        }
        buildPills(cutoffPillGroup, ['WAG', 'MAG'], cutoffActiveDisc, renderCutoffs);
        renderCutoffs(cutoffActiveDisc);
    }

    function renderDifficultyTrends() {
        var pillGroup = $('nrd-difficulty-pills'); pillGroup.innerHTML = '';
        var activeDisc = 'WAG';
        function render(disc) {
            activeDisc = disc;
            pillGroup.querySelectorAll('.pill').forEach(function(p) { p.classList.toggle('active', p.dataset.disc === disc); });
            var apparatus = apparatusForDisc(disc).filter(function(a) { return a.svKey; });
            var levels = levelsForDisc(disc);
            var rows = getScoreData(disc);
            var barLabels = apparatus.map(function(a) { return a.short; });
            var datasets = levels.map(function(lev, i) {
                var levRows = rows.filter(function(r) { return r.CompLevel === lev; });
                var means = [], stdDevs = [];
                apparatus.forEach(function(app) {
                    var svs = []; levRows.forEach(function(r) { var v = parseFloat(r[app.svKey]); if (v > 0) svs.push(v); });
                    if (svs.length) { var mean = svs.reduce(function(a, b) { return a + b; }, 0) / svs.length; var variance = svs.reduce(function(s, v) { return s + Math.pow(v - mean, 2); }, 0) / svs.length; means.push(mean); stdDevs.push(Math.sqrt(variance)); } else { means.push(0); stdDevs.push(0); }
                });
                return { label: lev, data: means, stdDevs: stdDevs, backgroundColor: levelShade(disc, i, levels.length), borderRadius: 3 };
            });
            var barCanvas = $('nrd-chart-difficulty-bars'), lineCanvas = $('nrd-chart-difficulty-lines');
            charts = charts.filter(function(c) { if (c.canvas === barCanvas || c.canvas === lineCanvas) { c.destroy(); return false; } return true; });
            var errorBarPlugin = { id: 'errorBars', afterDraw: function(chart) { var ctx = chart.ctx; chart.data.datasets.forEach(function(dataset, dsIdx) { if (!dataset.stdDevs) return; var meta = chart.getDatasetMeta(dsIdx); meta.data.forEach(function(bar, idx) { var sd = dataset.stdDevs[idx]; if (!sd || sd === 0) return; var mean = dataset.data[idx]; if (!mean) return; var yScale = chart.scales.y; var yTop = yScale.getPixelForValue(mean + sd); var yBot = yScale.getPixelForValue(mean - sd); var x = bar.x; var halfWidth = Math.min(bar.width * 0.3, 8); ctx.save(); ctx.strokeStyle = 'rgba(0,0,0,0.6)'; ctx.lineWidth = 1.5; ctx.beginPath(); ctx.moveTo(x, yTop); ctx.lineTo(x, yBot); ctx.moveTo(x - halfWidth, yTop); ctx.lineTo(x + halfWidth, yTop); ctx.moveTo(x - halfWidth, yBot); ctx.lineTo(x + halfWidth, yBot); ctx.stroke(); ctx.restore(); }); }); } };
            var barChart = new Chart(barCanvas, { type: 'bar', data: { labels: barLabels, datasets: datasets }, options: { responsive: true, plugins: { title: { display: true, text: 'Mean Start Value by Apparatus and Level (' + disc + ')', font: { size: 14 } } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Mean SV' } } } }, plugins: [errorBarPlugin] });
            charts.push(barChart);
            var lineDatasets = apparatus.map(function(app, i) { var data = levels.map(function(lev) { var levRows = rows.filter(function(r) { return r.CompLevel === lev; }); var svs = []; levRows.forEach(function(r) { var v = parseFloat(r[app.svKey]); if (v > 0) svs.push(v); }); return svs.length ? svs.reduce(function(a, b) { return a + b; }, 0) / svs.length : null; }); var hue = (i / apparatus.length) * 360; return { label: app.short, data: data, borderColor: 'hsl(' + hue + ',70%,50%)', backgroundColor: 'hsl(' + hue + ',70%,50%)', tension: 0.3, fill: false, pointRadius: 5 }; });
            var lineChart = new Chart(lineCanvas, { type: 'line', data: { labels: levels, datasets: lineDatasets }, options: { responsive: true, plugins: { title: { display: true, text: 'SV Progression Across Levels (' + disc + ')', font: { size: 14 } } }, scales: { y: { title: { display: true, text: 'Mean SV' } }, x: { title: { display: true, text: 'Level (low \u2192 high)' } } } } });
            charts.push(lineChart);
        }
        buildPills(pillGroup, ['WAG', 'MAG'], activeDisc, render);
        render(activeDisc);
    }

    function renderExecutionAnalysis() {
        var pillGroup = $('nrd-execution-pills'), tableContainer = $('nrd-execution-table-container'), levelContainer = $('nrd-execution-levels');
        pillGroup.innerHTML = ''; tableContainer.innerHTML = ''; levelContainer.innerHTML = '';
        var activeDisc = 'WAG';
        function render(disc) {
            activeDisc = disc; tableContainer.innerHTML = '';
            pillGroup.querySelectorAll('.pill').forEach(function(p) { p.classList.toggle('active', p.dataset.disc === disc); });
            var checkedLevels = buildLevelCheckboxes('execution', disc, levelContainer, function() { render(disc); });
            if (!checkedLevels.length) { var execCanvas = $('nrd-chart-execution'); charts = charts.filter(function(c) { if (c.canvas === execCanvas) { c.destroy(); return false; } return true; }); var emptyChart = new Chart(execCanvas, { type: 'bar', data: { labels: [], datasets: [] }, options: { responsive: true, plugins: { title: { display: true, text: 'Please select at least one level', font: { size: 14 } } } } }); charts.push(emptyChart); return; }
            var apparatus = apparatusForDisc(disc).filter(function(a) { return a.svKey; });
            var allRows = getScoreData(disc);
            if (!allRows.length) { var execCanvas = $('nrd-chart-execution'); charts = charts.filter(function(c) { if (c.canvas === execCanvas) { c.destroy(); return false; } return true; }); var emptyChart = new Chart(execCanvas, { type: 'bar', data: { labels: [], datasets: [] }, options: { responsive: true, plugins: { title: { display: true, text: 'No data available for ' + disc + ' on this tab', font: { size: 14 } } } } }); charts.push(emptyChart); return; }
            var eData = [], tableRows = [];
            checkedLevels.forEach(function(lev, levIdx) {
                var levRows = allRows.filter(function(r) { return r.CompLevel === lev; });
                apparatus.forEach(function(app) {
                    var eScores = [];
                    levRows.forEach(function(r) {
                        var score = parseFloat(r[app.key]);
                        if (!score || score <= 0) return;
                        // Try row's own SV first, then fall back to svLookup
                        var sv = parseFloat(r[app.svKey]);
                        if (!sv || sv <= 0) {
                            var svEntry = svLookup[athleteKey(r)];
                            sv = svEntry ? svEntry[app.svKey] : null;
                        }
                        if (!sv || sv <= 0) return;
                        eScores.push(score - sv);
                    });
                    if (eScores.length > 0) {
                        var stats = computeStats(eScores);
                        eData.push({ apparatus: app.short, level: lev, mean: stats.mean, n: stats.n, levIdx: levIdx });
                        tableRows.push({ apparatus: app.label, level: lev, n: stats.n, mean: stats.mean, median: stats.median, stdDev: stats.stdDev });
                    }
                });
            });
            var execCanvas = $('nrd-chart-execution');
            charts = charts.filter(function(c) { if (c.canvas === execCanvas) { c.destroy(); return false; } return true; });
            var barLabels = [], barData = [], barColors = [];
            eData.forEach(function(d) { barLabels.push(d.apparatus + ' ' + d.level); barData.push(d.mean); barColors.push(levelShade(disc, d.levIdx, checkedLevels.length)); });
            var execChart = new Chart(execCanvas, { type: 'bar', data: { labels: barLabels, datasets: [{ label: 'Mean Implied E-Score', data: barData, backgroundColor: barColors, borderRadius: 3 }] }, options: { responsive: true, plugins: { title: { display: true, text: 'Mean Implied Execution Score (' + disc + ')', font: { size: 14 } }, legend: { display: false } }, scales: { y: { title: { display: true, text: 'E-Score (Score - SV)' } }, x: { ticks: { maxRotation: 45 } } } } });
            charts.push(execChart);
            if (tableRows.length) { var table = document.createElement('table'); table.className = 'data-table'; table.innerHTML = '<thead><tr><th>Apparatus</th><th>Level</th><th class="num-col">N</th><th class="num-col">Mean E</th><th class="num-col">Median E</th><th class="num-col">Std Dev</th></tr></thead><tbody></tbody>'; var tbody = table.querySelector('tbody'); tableRows.forEach(function(r) { var tr = document.createElement('tr'); tr.innerHTML = '<td>' + r.apparatus + '</td><td>' + r.level + '</td><td class="num">' + r.n + '</td><td class="num">' + f3(r.mean) + '</td><td class="num">' + f3(r.median) + '</td><td class="num">' + f3(r.stdDev) + '</td>'; tbody.appendChild(tr); }); tableContainer.appendChild(table); makeSortable(table); }
        }
        buildPills(pillGroup, ['WAG', 'MAG'], activeDisc, render);
        render(activeDisc);
    }

    // ============================================================
    // CROSS-ROUND INSIGHTS (Combined tab only)
    // ============================================================
    function renderCombinedInsights() {
        if (activeTab !== 'combined') return;
        var cardsEl = $('nrd-combined-delta-cards'); cardsEl.innerHTML = '';
        var deltaTableEl = $('nrd-combined-delta-table'); deltaTableEl.innerHTML = '';
        var pillGroup = $('nrd-combined-pills'), levelContainer = $('nrd-combined-levels');
        pillGroup.innerHTML = ''; levelContainer.innerHTML = '';
        var activeDisc = 'WAG';

        function matchAthletes(disc) {
            var pRows = prelimsData[disc === 'WAG' ? 'wag' : 'mag'] || [];
            var fRows = finalsData[disc === 'WAG' ? 'wag' : 'mag'] || [];
            var prelimsByKey = {};
            pRows.forEach(function(r) { prelimsByKey[athleteKey(r)] = r; });
            var matched = [];
            fRows.forEach(function(fRow) {
                var key = athleteKey(fRow);
                var pRow = prelimsByKey[key];
                if (pRow) matched.push({ prelim: pRow, final: fRow, key: key, level: pRow.CompLevel });
            });
            return matched;
        }

        function render(disc) {
            activeDisc = disc;
            cardsEl.innerHTML = ''; deltaTableEl.innerHTML = '';
            pillGroup.querySelectorAll('.pill').forEach(function(p) { p.classList.toggle('active', p.dataset.disc === disc); });
            var checkedLevels = buildLevelCheckboxes('combined', disc, levelContainer, function() { render(disc); });
            if (!checkedLevels.length) { cardsEl.innerHTML = ''; deltaTableEl.innerHTML = '<div class="no-data-msg">Please select at least one level.</div>'; return; }

            var matched = matchAthletes(disc).filter(function(m) { return checkedLevels.indexOf(m.level) !== -1; });
            if (!matched.length) {
                cardsEl.innerHTML = '';
                deltaTableEl.innerHTML = '<div class="no-data-msg">No matched athletes found between prelims and finals for ' + disc + '.</div>';
                // Clear charts
                var deltaCanvas = $('nrd-chart-combined-delta'), spreadCanvas = $('nrd-chart-combined-spread');
                charts = charts.filter(function(c) { if (c.canvas === deltaCanvas || c.canvas === spreadCanvas) { c.destroy(); return false; } return true; });
                return;
            }

            var apparatus = apparatusForDisc(disc).filter(function(a) { return a.short !== 'AA'; });

            // Summary cards
            var aaDeltas = [];
            matched.forEach(function(m) {
                if (hasCompleteAA(m.prelim, disc) && hasCompleteAA(m.final, disc)) {
                    var pAA = parseFloat(m.prelim.AA_Score), fAA = parseFloat(m.final.AA_Score);
                    if (pAA > 0 && fAA > 0) aaDeltas.push(fAA - pAA);
                }
            });
            var meanAADelta = aaDeltas.length ? aaDeltas.reduce(function(a,b){return a+b;},0) / aaDeltas.length : 0;
            var improvedCount = aaDeltas.filter(function(d) { return d > 0; }).length;
            var meanAbsDelta = aaDeltas.length ? aaDeltas.reduce(function(a,b){return a+Math.abs(b);},0) / aaDeltas.length : 0;

            cardsEl.appendChild(makeCard('Athletes in Both Rounds', matched.length, 'special'));
            cardsEl.appendChild(makeCardDetail('Mean AA Change', (meanAADelta >= 0 ? '+' : '') + f3(meanAADelta), 'finals - prelims', 'special'));
            cardsEl.appendChild(makeCardDetail('Improved in Finals', aaDeltas.length ? pct(improvedCount, aaDeltas.length) : '\u2014', improvedCount + ' of ' + aaDeltas.length + ' AA athletes', 'special'));
            cardsEl.appendChild(makeCardDetail('Mean |AA Change|', f3(meanAbsDelta), 'average absolute change', 'special'));

            // Per-apparatus delta table
            var apparatusWithAA = apparatusForDisc(disc);
            var tableRows = [];
            apparatusWithAA.forEach(function(app) {
                var deltas = [];
                matched.forEach(function(m) {
                    if (app.short === 'AA') {
                        if (!hasCompleteAA(m.prelim, disc) || !hasCompleteAA(m.final, disc)) return;
                    }
                    var pScore = parseFloat(m.prelim[app.key]), fScore = parseFloat(m.final[app.key]);
                    if (pScore > 0 && fScore > 0) deltas.push(fScore - pScore);
                });
                if (deltas.length) {
                    var stats = computeStats(deltas);
                    var improved = deltas.filter(function(d) { return d > 0; }).length;
                    tableRows.push({ apparatus: app.label, n: stats.n, mean: stats.mean, median: stats.median, stdDev: stats.stdDev, improved: pct(improved, stats.n) });
                }
            });
            if (tableRows.length) {
                var table = document.createElement('table'); table.className = 'data-table';
                table.innerHTML = '<thead><tr><th>Apparatus</th><th class="num-col">N</th><th class="num-col">Mean \u0394</th><th class="num-col">Median \u0394</th><th class="num-col">Std Dev</th><th class="num-col">% Improved</th></tr></thead><tbody></tbody>';
                var tbody = table.querySelector('tbody');
                tableRows.forEach(function(r) {
                    var tr = document.createElement('tr');
                    tr.innerHTML = '<td>' + r.apparatus + '</td><td class="num">' + r.n + '</td><td class="num">' + (r.mean >= 0 ? '+' : '') + f3(r.mean) + '</td><td class="num">' + (r.median >= 0 ? '+' : '') + f3(r.median) + '</td><td class="num">' + f3(r.stdDev) + '</td><td class="num">' + r.improved + '</td>';
                    tbody.appendChild(tr);
                });
                deltaTableEl.appendChild(table); makeSortable(table);
            }

            // Score delta distribution chart (AA)
            var deltaCanvas = $('nrd-chart-combined-delta');
            charts = charts.filter(function(c) { if (c.canvas === deltaCanvas) { c.destroy(); return false; } return true; });
            if (aaDeltas.length) {
                var hist = buildHistogram(aaDeltas, 0.5);
                var deltaChart = new Chart(deltaCanvas, { type: 'bar', data: { labels: hist.labels, datasets: [{ label: 'Athletes', data: hist.counts, backgroundColor: aaDeltas.map(function(_, i) { var edge = parseFloat(hist.labels[Math.min(i, hist.labels.length-1)]); return edge >= 0 ? 'rgba(46,204,113,0.7)' : 'rgba(231,76,139,0.7)'; }).length ? hist.labels.map(function(l) { return parseFloat(l) >= 0 ? 'rgba(46,204,113,0.7)' : 'rgba(231,76,139,0.7)'; }) : [discColorLight(disc)], borderRadius: 2 }] }, options: { responsive: true, plugins: { title: { display: true, text: 'AA Score Change Distribution: Finals - Prelims (' + disc + ')', font: { size: 14 } }, legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Athletes' }, ticks: { precision: 0 } }, x: { title: { display: true, text: 'Score Change (positive = improved)' } } } } });
                charts.push(deltaChart);
            }

            // Spread comparison chart (stddev prelims vs finals per apparatus)
            var spreadCanvas = $('nrd-chart-combined-spread');
            charts = charts.filter(function(c) { if (c.canvas === spreadCanvas) { c.destroy(); return false; } return true; });
            var spreadLabels = [], prelimStdDevs = [], finalsStdDevs = [];
            apparatus.forEach(function(app) {
                var pScores = [], fScores = [];
                matched.forEach(function(m) {
                    var ps = parseFloat(m.prelim[app.key]), fs = parseFloat(m.final[app.key]);
                    if (ps > 0) pScores.push(ps);
                    if (fs > 0) fScores.push(fs);
                });
                var pStats = computeStats(pScores), fStats = computeStats(fScores);
                if (pStats && fStats) {
                    spreadLabels.push(app.short);
                    prelimStdDevs.push(pStats.stdDev);
                    finalsStdDevs.push(fStats.stdDev);
                }
            });
            if (spreadLabels.length) {
                var spreadChart = new Chart(spreadCanvas, { type: 'bar', data: { labels: spreadLabels, datasets: [{ label: 'Prelims Std Dev', data: prelimStdDevs, backgroundColor: 'rgba(52,152,219,0.6)', borderRadius: 3 }, { label: 'Finals Std Dev', data: finalsStdDevs, backgroundColor: 'rgba(231,76,139,0.6)', borderRadius: 3 }] }, options: { responsive: true, plugins: { title: { display: true, text: 'Score Spread Comparison: Prelims vs Finals (' + disc + ')', font: { size: 14 } } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Standard Deviation' } } } } });
                charts.push(spreadChart);
            }
        }
        buildPills(pillGroup, ['WAG', 'MAG'], activeDisc, render);
        render(activeDisc);
    }

    // ============================================================
    // RENDER ALL
    // ============================================================
    function renderAll() {
        destroyAllCharts();
        updateSectionVisibility();
        renderOverview();
        renderScoreDistributions();
        renderSVDistributions();
        renderSummaryStats();
        renderQualifierAnalysis();
        renderDifficultyTrends();
        renderExecutionAnalysis();
        renderCombinedInsights();
    }

    // ============================================================
    // TAB SWITCHING
    // ============================================================
    function setupTabs() {
        document.querySelectorAll('.nrd-tab').forEach(function(tab) {
            tab.addEventListener('click', function() {
                activeTab = tab.dataset.tab;
                document.querySelectorAll('.nrd-tab').forEach(function(t) { t.classList.toggle('active', t === tab); });
                renderAll();
            });
        });
    }

    // ============================================================
    // INIT
    // ============================================================
    async function init() {
        var bar = $('nrd-loading-bar-fill'), status = $('nrd-loading-status'), detail = $('nrd-loading-detail');
        var keys = Object.keys(DATA_FILES), loaded = 0, total = keys.length;
        status.textContent = 'Loading 0 of ' + total + ' files...';

        var rawData = {};
        await Promise.allSettled(keys.map(async function(key) {
            try {
                var data = await fetchXLSX(DATA_FILES[key]);
                loaded++; bar.style.width = (loaded / total * 100) + '%';
                status.textContent = 'Loading ' + loaded + ' of ' + total + ' files...';
                detail.textContent = FILE_LABELS[key] || key;
                rawData[key] = data;
            } catch(e) {
                loaded++; bar.style.width = (loaded / total * 100) + '%';
                status.textContent = 'Loading ' + loaded + ' of ' + total + ' files...';
                detail.textContent = 'Failed: ' + (FILE_LABELS[key] || key);
                console.warn('Failed to load ' + key + ':', e);
                rawData[key] = [];
            }
        }));

        status.textContent = 'Processing data...';
        processRawData(rawData);

        setupTabs();
        $('nrd-filter-discipline').addEventListener('change', function() { renderAll(); });
        $('nrd-filter-category').addEventListener('change', renderAll);

        status.textContent = 'Rendering dashboard...';
        renderAll();

        $('nrd-loading').style.display = 'none';
        $('nrd-content').style.display = 'block';
    }

    init();
})();
</script>

</body>
</html>
